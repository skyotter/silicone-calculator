<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>矽利康使用支數計算器（含類別）</title>
  <style>
    :root{
      --bg:#f7f9fb;--card:#fff;--ink:#111;--muted:#666;--line:#eee;
      --primary:#1f8ef1;--ghost-bg:#e9eef9;--ghost-ink:#1f3b6b;--bad:#ff6b6b;--tile:#f5f7fb;
    }
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink);padding:18px}
    .page{max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(20,30,50,0.06);padding:18px}
    h1{margin:0 0 4px;font-size:22px}
    p.small{margin:0;color:#555}
    .muted{color:var(--muted);font-size:13px}
    .categories{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:1000px){.categories{grid-template-columns:1fr 1fr}}
    .cat-header{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:8px}
    .cat-title{font-size:18px;font-weight:700;margin-right:auto}
    label{font-size:13px;color:#333;display:block}
    input[type="number"]{padding:8px;border:1px solid #d7dbe0;border-radius:6px}
    input.w90{width:90px}
    .btn{padding:8px 10px;border:0;border-radius:6px;background:var(--primary);color:#fff;cursor:pointer}
    .btn.ghost{background:var(--ghost-bg);color:var(--ghost-ink)}
    .btn.bad{background:var(--bad)}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    th{background:#fbfcff;font-weight:600}
    .right{text-align:right}
    .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .tile{background:var(--tile);padding:12px;border-radius:10px;min-width:180px}
    .tile .k{font-size:13px;color:#444}
    .tile .v{font-weight:700;font-size:18px}
    .overall{display:flex;gap:16px;flex-wrap:wrap;justify-content:space-between;align-items:center}
    .overall .tiles{display:flex;gap:12px;flex-wrap:wrap}
    /* 手機表格卡片化 */
    @media(max-width:600px){
      table, thead, tbody, th, td, tr { display:block; width:95%; }
      thead{display:none}
      tr{background:#fafafa;margin-bottom:10px;border-radius:8px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
      td{border:none;padding:6px 0}
      td:before{display:block;font-size:12px;font-weight:600;color:#444;margin-bottom:2px}
      td:nth-child(1):before{content:"單條長度 (mm)"}
      td:nth-child(2):before{content:"數量 (條)"}
      td:nth-child(3):before{content:"小計 (mm)"}
      td:nth-child(4):before{content:"操作"}
      input[type="number"]{width:90%}
      .btn.bad{width:90%}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>矽利康使用支數計算器（含類別：庫版／內襯）</h1>
      <p class="small">在各類別中輸入需要封縫的 <b>單條長度（mm）</b> 與 <b>數量</b>，系統會以 <b>mm</b> 進行整數運算並計算需要幾支矽利康。</p>
      <p class="muted">提示：每個類別可獨立設定「一支矽利康可打長度（mm）」。最下方顯示全部類別合計。</p>
    </div>

    <div class="categories" id="cats"></div>

    <div class="card">
      <div class="overall">
        <div>
          <div style="font-weight:700;font-size:18px">全部類別合計</div>
          <div class="muted">支數為各類別所需支數相加（各以自身可打長度計算）。</div>
        </div>
        <div class="tiles">
          <div class="tile">
            <div class="k">總長度</div>
            <div class="v" id="overallM">0 m</div>
            <div class="muted" id="overallMM">0 mm</div>
          </div>
          <div class="tile">
            <div class="k">需要矽利康支數（加總）</div>
            <div class="v" id="overallUnits">0 支</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card"><div class="muted">快捷鍵：<code>Ctrl/Cmd + Enter</code> 在目前類別新增一列。</div></div>
  </div>

  <script>
    // —— 基本函式（用 ES5/DOM API，避免相容性問題） ——
    function clampInt(v){ var n = Math.floor(Number(v)); return isFinite(n) && n >= 0 ? n : 0; }
    function mmToMetersStr(mm){
      var m = mm / 1000;
      return (Math.round(m * 1000) / 1000).toString().replace(/\.?0+$/,'') + ' m';
    }
    function fmtMm(mm){ return clampInt(mm) + ' mm'; }
    function round1(x){ return Math.round(x * 10) / 10; }

    // —— 類別工廠 ——（避免 class/新語法造成的問題）
    function makeCategory(opts){
      var key = opts.key;
      var title = opts.title;
      var defaultUnitMm = typeof opts.defaultUnitMm === 'number' ? opts.defaultUnitMm : 28000;
      var host = opts.container;
      var rows = [];

      var wrap = document.createElement('div'); wrap.className = 'card'; host.appendChild(wrap);

      // Header
      var header = document.createElement('div'); header.className = 'cat-header'; wrap.appendChild(header);
      var titleEl = document.createElement('div'); titleEl.className = 'cat-title'; titleEl.textContent = title; header.appendChild(titleEl);

      var unitLabel = document.createElement('label'); unitLabel.textContent = '一支矽利康可打長度（mm）'; header.appendChild(unitLabel);
      var unitInput = document.createElement('input'); unitInput.type = 'number'; unitInput.min = '1'; unitInput.step = '1';
      unitInput.value = defaultUnitMm; unitInput.className = 'w90'; unitLabel.appendChild(unitInput);

      var btnRow = document.createElement('div'); btnRow.className = 'btn-row'; header.appendChild(btnRow);
      var addBtn = document.createElement('button'); addBtn.className = 'btn'; addBtn.textContent = '+ 新增一種長度'; btnRow.appendChild(addBtn);
      var sampleBtn = document.createElement('button'); sampleBtn.className = 'btn ghost'; sampleBtn.textContent = '範例資料'; btnRow.appendChild(sampleBtn);
      var clearBtn = document.createElement('button'); clearBtn.className = 'btn ghost'; clearBtn.textContent = '清空所有'; btnRow.appendChild(clearBtn);

      // Table
      var table = document.createElement('table'); table.setAttribute('aria-label', title + ' 長度列表'); wrap.appendChild(table);
      var thead = document.createElement('thead');
      thead.innerHTML = '<tr>\
          <th style="width:35%">單條長度（mm）</th>\
          <th style="width:25%">數量（條）</th>\
          <th style="width:25%" class="right">小計（mm）</th>\
          <th style="width:15%">操作</th>\
        </tr>';
      var tbody = document.createElement('tbody');
      table.appendChild(thead); table.appendChild(tbody);

      // Summary
      var sum = document.createElement('div'); sum.className = 'summary';
      sum.innerHTML = '<div class="tile">\
          <div class="k">本類別總長度</div>\
          <div class="v" id="'+key+'-m">0 m</div>\
          <div class="muted" id="'+key+'-mm">0 mm</div>\
        </div>\
        <div class="tile">\
          <div class="k">本類別需要支數</div>\
          <div class="v" id="'+key+'-u">0 支</div>\
        </div>';
      wrap.appendChild(sum);
      var lenMEl = sum.querySelector('#'+key+'-m');
      var lenMmEl = sum.querySelector('#'+key+'-mm');
      var unitsEl = sum.querySelector('#'+key+'-u');

      function compute(){
        var unitMm = clampInt(unitInput.value)||0;
        var totalMm = 0;
        for (var i=0;i<rows.length;i++){
          var r = rows[i];
          var lenMm = clampInt(r.len.value);
          var qty = clampInt(r.qty.value);
          var sub = lenMm * qty;
          totalMm += sub;
          r.sub.textContent = fmtMm(sub);
        }
        var units = unitMm > 0 ? totalMm / unitMm : 0;
        return {totalMm: totalMm, unitsRaw: units};
      }

      function recalc(){
        var c = compute();
        lenMEl.textContent = mmToMetersStr(c.totalMm);
        lenMmEl.textContent = fmtMm(c.totalMm);
        unitsEl.textContent = round1(c.unitsRaw) + ' 支';
        updateOverall();
      }

      function createRow(len, qty){
        var tr = document.createElement('tr'); tbody.appendChild(tr);
        var td1 = document.createElement('td'); var lenInput = document.createElement('input');
        lenInput.type = 'number'; lenInput.min='0'; lenInput.step='1'; lenInput.value = (len!=null?len:''); td1.appendChild(lenInput);
        var td2 = document.createElement('td'); var qtyInput = document.createElement('input');
        qtyInput.type = 'number'; qtyInput.min='0'; qtyInput.step='1'; qtyInput.value = (qty!=null?qty:1); td2.appendChild(qtyInput);
        var td3 = document.createElement('td'); td3.className='right muted'; td3.textContent='0 mm';
        var td4 = document.createElement('td'); var del = document.createElement('button'); del.className='btn bad'; del.textContent='刪除'; td4.appendChild(del);
        tr.appendChild(td1);tr.appendChild(td2);tr.appendChild(td3);tr.appendChild(td4);

        function onChange(){ recalc(); saveState(); }
        lenInput.addEventListener('input', onChange);
        qtyInput.addEventListener('input', onChange);
        del.addEventListener('click', function(){
          tbody.removeChild(tr);
          for (var i=0;i<rows.length;i++){ if (rows[i].tr===tr){ rows.splice(i,1); break; } }
          if (rows.length===0){ createRow('',1); } // 始終保有一列
          recalc(); saveState();
        });

        rows.push({tr:tr,len:lenInput,qty:qtyInput,sub:td3});
        recalc(); saveState();
      }

      function ensureOneRow(){
        if (rows.length===0){ createRow('',1); }
      }

      function saveState(){
        try{
          var data = {unit: clampInt(unitInput.value)||0, rows: []};
          for (var i=0;i<rows.length;i++){
            data.rows.push({len: clampInt(rows[i].len.value), qty: clampInt(rows[i].qty.value)});
          }
          localStorage.setItem(key+'_state', JSON.stringify(data));
        }catch(e){}
      }
      function loadState(){
        try{
          var raw = localStorage.getItem(key+'_state');
          if (!raw){ ensureOneRow(); recalc(); return; }
          var obj = JSON.parse(raw);
          if (obj && obj.unit){ unitInput.value = clampInt(obj.unit); }
          tbody.innerHTML=''; rows = [];
          if (obj && obj.rows && obj.rows.length){
            for (var i=0;i<obj.rows.length;i++){ createRow(obj.rows[i].len, obj.rows[i].qty); }
          }else{
            ensureOneRow();
          }
        }catch(e){
          ensureOneRow();
        }
        recalc();
      }

      // 事件
      addBtn.addEventListener('click', function(){ createRow('',1); });
      sampleBtn.addEventListener('click', function(){
        tbody.innerHTML=''; rows=[]; createRow(3370,2); createRow(2170,5); createRow(1470,10); recalc(); saveState();
      });
      clearBtn.addEventListener('click', function(){
        if (confirm('清空「'+title+'」所有列？')){ tbody.innerHTML=''; rows=[]; createRow('',1); recalc(); saveState(); }
      });
      unitInput.addEventListener('input', function(){ recalc(); saveState(); });

      // 供外部使用
      return {
        compute: compute,
        recalc: recalc,
        addRowHotkey: function(){ createRow('',1); },
        load: loadState,
        focusWithin: function(el){ return wrap.contains(el); }
      };
    }

    // —— 建立兩個類別與合計 —— 
    var catsWrap = document.getElementById('cats');
    var catA = makeCategory({key:'kuban', title:'庫版', defaultUnitMm:28000, container:catsWrap});
    var catB = makeCategory({key:'neichen', title:'內襯', defaultUnitMm:28000, container:catsWrap});
    var overallMEl = document.getElementById('overallM');
    var overallMMEl = document.getElementById('overallMM');
    var overallUnitsEl = document.getElementById('overallUnits');

    function updateOverall(){
      var a = catA.compute();
      var b = catB.compute();
      var totalMm = a.totalMm + b.totalMm;
      overallMEl.textContent = mmToMetersStr(totalMm);
      overallMMEl.textContent = fmtMm(totalMm);
      overallUnitsEl.textContent = round1(a.unitsRaw + b.unitsRaw) + ' 支';
    }

    // 初始載入：確保一定有可輸入的一列
    catA.load();
    catB.load();
    updateOverall();

    // 快捷鍵：Ctrl/Cmd + Enter => 在目前聚焦類別新增一列
    document.addEventListener('keydown', function(e){
      var isHotkey = (e.ctrlKey || e.metaKey) && e.key === 'Enter';
      if (!isHotkey) return;
      var active = document.activeElement;
      if (catA.focusWithin(active)) { catA.addRowHotkey(); }
      else if (catB.focusWithin(active)) { catB.addRowHotkey(); }
      else { catA.addRowHotkey(); } // 預設加在庫版
    });
  </script>
</body>
</html>
